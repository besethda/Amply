<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Amply â€“ Artist Setup</title>
    <link rel="stylesheet" href="/Styles/setup.css" />
    <link rel="stylesheet" href="../Styles/general.css" />
    <script type="module" src="scripts/setup.js" defer></script>
    <script type="module" src="scripts/general.js" defer></script>
  </head>
  <body>
    <header class="header">
      <img class="logo" src="../images/amply.png" />
      <nav class="nav">
        <a href="upload.html" class="nav-option">Artist</a>
        <a href="../Amply-listener/index.html" class="nav-option">Listener</a>
      </nav>
    </header>
    <h1>Amply â€“ Artist Setup</h1>

    <div class="section">
      <h2>Step 1 â€“ Create Your AWS Artist Environment</h2>
      <p>
        This will create your own secure S3 bucket, CloudFront distribution, and
        IAM role. Once created, copy the output values from AWS into the boxes
        below.
      </p>

      <label for="artistName">Enter your artist name (no spaces):</label>
      <input type="text" id="artistName" placeholder="e.g. skywave" />

      <button id="connectAwsBtn">ğŸŒ Launch AWS Setup</button>

      <p class="note">
        After setup finishes, open the â€œOutputsâ€ tab in AWS and copy these three
        values below:
      </p>

      <label>Bucket Name</label>
      <input
        type="text"
        id="bucketName"
        placeholder="amply-yourname-123456789"
      />

      <label>Role ARN</label>
      <input
        type="text"
        id="roleArn"
        placeholder="arn:aws:iam::123456789012:role/AmplyAccessRole-yourname"
      />

      <label>CloudFront Domain</label>
      <input
        type="text"
        id="cloudfrontDomain"
        placeholder="d123abc4def5.cloudfront.net"
      />

      <button id="saveConfigBtn">âœ… Save & Continue</button>
      <p id="configStatus"></p>
    </div>

    <script>
      const connectAwsBtn = document.getElementById("connectAwsBtn");
      const saveConfigBtn = document.getElementById("saveConfigBtn");
      const configStatus = document.getElementById("configStatus");

      const TEMPLATE_URL =
        "https://amply-templates.s3.eu-north-1.amazonaws.com/artist-environment.yml";
      const AMPLY_ACCOUNT_ID = "596430611327";
      const REGION = "eu-north-1";

      // Step 1: Launch AWS CloudFormation with prefilled params
      connectAwsBtn.addEventListener("click", () => {
        let artistName = document
          .getElementById("artistName")
          .value.trim()
          .toLowerCase()
          .replace(/[^a-z0-9-]/g, "");

        if (!artistName) {
          alert("Please enter your artist name (lowercase, no spaces).");
          return;
        }

        const stackName = `amply-${artistName}`;

        const url = `https://console.aws.amazon.com/cloudformation/home?region=${REGION}#/stacks/quickcreate?templateURL=${encodeURIComponent(
          TEMPLATE_URL
        )}&stackName=${encodeURIComponent(
          stackName
        )}&param_ArtistName=${encodeURIComponent(
          artistName
        )}&param_AmplyAccountId=${encodeURIComponent(
          AMPLY_ACCOUNT_ID
        )}&param_Region=${encodeURIComponent(REGION)}`;

        window.open(url, "_blank");
      });

      // Step 2: Save credentials locally and redirect to upload page
      saveConfigBtn.addEventListener("click", () => {
        const config = {
          artistName: document.getElementById("artistName").value.trim(),
          bucketName: document.getElementById("bucketName").value.trim(),
          roleArn: document.getElementById("roleArn").value.trim(),
          cloudfrontDomain: document
            .getElementById("cloudfrontDomain")
            .value.trim(),
        };

        if (!config.bucketName || !config.roleArn || !config.cloudfrontDomain) {
          configStatus.textContent = "âš ï¸ Please fill in all fields.";
          return;
        }

        localStorage.setItem("amplyArtistConfig", JSON.stringify(config));
        configStatus.textContent = "âœ… Configuration saved!";
        setTimeout(() => {
          window.location.href = "upload.html";
        }, 800);
      });
    </script>
  </body>
</html>
